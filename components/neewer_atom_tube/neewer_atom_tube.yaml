# neewer_atom_tube.yaml
# Fix: po OFF→ON vždy znovu pošli poslední barvu (jinak se trubka resetne na bílou)

substitutions:
  # očekávané vars z include:
  # dev_id, dev_name, dev_mac, service_uuid, char_uuid

ble_client:
  - id: ${dev_id}_client
    mac_address: ${dev_mac}
    on_connect:
      then:
        - script.execute: ${dev_id}_init

globals:
  - id: ${dev_id}_last_r
    type: uint8_t
    restore_value: true
    initial_value: "0"
  - id: ${dev_id}_last_g
    type: uint8_t
    restore_value: true
    initial_value: "0"
  - id: ${dev_id}_last_b
    type: uint8_t
    restore_value: true
    initial_value: "0"
  - id: ${dev_id}_last_cw
    type: uint8_t
    restore_value: true
    initial_value: "0"
  - id: ${dev_id}_last_ww
    type: uint8_t
    restore_value: true
    initial_value: "0"

  - id: ${dev_id}_last_bri
    type: uint8_t
    restore_value: true
    initial_value: "50"

  - id: ${dev_id}_saved_bri
    type: uint8_t
    restore_value: true
    initial_value: "50"

  # co už jsme poslali (pro anti-flicker / dedup)
  - id: ${dev_id}_sent_r
    type: uint8_t
    restore_value: false
    initial_value: "255"
  - id: ${dev_id}_sent_g
    type: uint8_t
    restore_value: false
    initial_value: "255"
  - id: ${dev_id}_sent_b
    type: uint8_t
    restore_value: false
    initial_value: "255"
  - id: ${dev_id}_sent_cw
    type: uint8_t
    restore_value: false
    initial_value: "255"
  - id: ${dev_id}_sent_ww
    type: uint8_t
    restore_value: false
    initial_value: "255"
  - id: ${dev_id}_sent_bri
    type: uint8_t
    restore_value: false
    initial_value: "255"

  # OFF→ON detekce
  - id: ${dev_id}_was_on
    type: bool
    restore_value: false
    initial_value: "false"
  - id: ${dev_id}_force_resend_color
    type: bool
    restore_value: false
    initial_value: "false"

output:
  - platform: template
    id: ${dev_id}_out_r
    type: float
    write_action:
      - lambda: |-
          (void) state;
  - platform: template
    id: ${dev_id}_out_g
    type: float
    write_action:
      - lambda: |-
          (void) state;
  - platform: template
    id: ${dev_id}_out_b
    type: float
    write_action:
      - lambda: |-
          (void) state;
  - platform: template
    id: ${dev_id}_out_cw
    type: float
    write_action:
      - lambda: |-
          (void) state;
  - platform: template
    id: ${dev_id}_out_ww
    type: float
    write_action:
      - lambda: |-
          (void) state;

light:
  - platform: rgbww
    name: "${dev_name}"
    id: ${dev_id}_light
    red: ${dev_id}_out_r
    green: ${dev_id}_out_g
    blue: ${dev_id}_out_b
    cold_white: ${dev_id}_out_cw
    warm_white: ${dev_id}_out_ww
    cold_white_color_temperature: 6500 K
    warm_white_color_temperature: 2700 K
    gamma_correct: 1.0
    constant_brightness: false
    restore_mode: RESTORE_DEFAULT_OFF
    default_transition_length: 0s

    on_state:
      then:
        - lambda: |-
            auto cv = id(${dev_id}_light).current_values;

            bool is_on = cv.get_state();
            bool prev_on = id(${dev_id}_was_on);
            id(${dev_id}_was_on) = is_on;

            // kanály 0..1 -> 0..255
            uint8_t r  = (uint8_t) lroundf(cv.get_red()        * 255.0f);
            uint8_t g  = (uint8_t) lroundf(cv.get_green()      * 255.0f);
            uint8_t b  = (uint8_t) lroundf(cv.get_blue()       * 255.0f);
            uint8_t cw = (uint8_t) lroundf(cv.get_cold_white() * 255.0f);
            uint8_t ww = (uint8_t) lroundf(cv.get_warm_white() * 255.0f);

            id(${dev_id}_last_r)  = r;
            id(${dev_id}_last_g)  = g;
            id(${dev_id}_last_b)  = b;
            id(${dev_id}_last_cw) = cw;
            id(${dev_id}_last_ww) = ww;

            // brightness 0..1 -> 0..100
            float br = cv.get_brightness();
            uint8_t bri = (uint8_t) lroundf(br * 100.0f);
            if (bri > 100) bri = 100;

            if (!is_on) {
              id(${dev_id}_last_bri) = 0;
            } else {
              if (bri == 0) {
                uint8_t fallback = id(${dev_id}_saved_bri);
                id(${dev_id}_last_bri) = (fallback == 0) ? (uint8_t)50 : fallback;
              } else {
                id(${dev_id}_last_bri) = bri;
                id(${dev_id}_saved_bri) = bri;
              }
            }

            // Když jdeme OFF -> ON, vynutíme resend barvy
            if (is_on && !prev_on) {
              id(${dev_id}_force_resend_color) = true;
            }

        - script.execute: ${dev_id}_apply_state

interval:
  - interval: 5s
    then:
      - script.execute: ${dev_id}_keepalive

script:
  - id: ${dev_id}_apply_state
    mode: restart
    then:
      - delay: 40ms
      - script.execute: ${dev_id}_push

  - id: ${dev_id}_push
    mode: restart
    then:
      # OFF -> pošli jen brightness=0 (barvu neřeš)
      - if:
          condition:
            lambda: |-
              return id(${dev_id}_last_bri) == 0;
          then:
            - if:
                condition:
                  lambda: |-
                    return id(${dev_id}_sent_bri) != 0;
                then:
                  - script.execute: ${dev_id}_send_brightness
          else:
            # ON -> pokud je to OFF→ON, pošli nejdřív brightness, pak barvu (vždy)
            - if:
                condition:
                  lambda: |-
                    return id(${dev_id}_force_resend_color);
                then:
                  - script.execute: ${dev_id}_send_color
                  - lambda: |-
                      id(${dev_id}_force_resend_color) = false;
                  - delay: 90ms
                  - script.execute: ${dev_id}_send_brightness                    
                else:
                  # běžné změny: color jen když se změnil
                  - if:
                      condition:
                        lambda: |-
                          return id(${dev_id}_last_r)  != id(${dev_id}_sent_r)  ||
                                 id(${dev_id}_last_g)  != id(${dev_id}_sent_g)  ||
                                 id(${dev_id}_last_b)  != id(${dev_id}_sent_b)  ||
                                 id(${dev_id}_last_cw) != id(${dev_id}_sent_cw) ||
                                 id(${dev_id}_last_ww) != id(${dev_id}_sent_ww);
                      then:
                        - script.execute: ${dev_id}_send_color

                  # brightness jen když se změnil
                  - if:
                      condition:
                        lambda: |-
                          return id(${dev_id}_last_bri) != id(${dev_id}_sent_bri);
                      then:
                        - script.execute: ${dev_id}_send_brightness

  - id: ${dev_id}_init
    then:
      - ble_client.ble_write:
          id: ${dev_id}_client
          service_uuid: ${service_uuid}
          characteristic_uuid: ${char_uuid}
          value: !lambda |-
            auto hexval = [](char c) -> uint8_t {
              if (c >= '0' && c <= '9') return (uint8_t)(c - '0');
              if (c >= 'A' && c <= 'F') return (uint8_t)(c - 'A' + 10);
              if (c >= 'a' && c <= 'f') return (uint8_t)(c - 'a' + 10);
              return 0;
            };
            auto parse_mac = [&](const std::string &s) -> std::vector<uint8_t> {
              std::vector<uint8_t> mac; mac.reserve(6);
              for (size_t i = 0; i + 1 < s.size() && mac.size() < 6;) {
                if (s[i] == ':' || s[i] == '-') { i++; continue; }
                mac.push_back((uint8_t)((hexval(s[i]) << 4) | hexval(s[i+1])));
                i += 2;
              }
              while (mac.size() < 6) mac.push_back(0x00);
              return mac;
            };

            std::vector<uint8_t> mac = parse_mac("${dev_mac}");
            std::vector<uint8_t> msg = {0x78,0x9F,0x0C};
            msg.insert(msg.end(), mac.begin(), mac.end());
            uint8_t tail[] = {0x01,0x00,0x00,0x00,0x00,0x00};
            msg.insert(msg.end(), std::begin(tail), std::end(tail));
            uint8_t cs = 0; for (auto b : msg) cs += b;
            msg.push_back(cs);
            return msg;

  - id: ${dev_id}_keepalive
    then:
      - ble_client.ble_write:
          id: ${dev_id}_client
          service_uuid: ${service_uuid}
          characteristic_uuid: ${char_uuid}
          value: !lambda |-
            auto hexval = [](char c) -> uint8_t {
              if (c >= '0' && c <= '9') return (uint8_t)(c - '0');
              if (c >= 'A' && c <= 'F') return (uint8_t)(c - 'A' + 10);
              if (c >= 'a' && c <= 'f') return (uint8_t)(c - 'a' + 10);
              return 0;
            };
            auto parse_mac = [&](const std::string &s) -> std::vector<uint8_t> {
              std::vector<uint8_t> mac; mac.reserve(6);
              for (size_t i = 0; i + 1 < s.size() && mac.size() < 6;) {
                if (s[i] == ':' || s[i] == '-') { i++; continue; }
                mac.push_back((uint8_t)((hexval(s[i]) << 4) | hexval(s[i+1])));
                i += 2;
              }
              while (mac.size() < 6) mac.push_back(0x00);
              return mac;
            };

            std::vector<uint8_t> mac = parse_mac("${dev_mac}");
            std::vector<uint8_t> msg = {0x78,0x9E,0x06};
            msg.insert(msg.end(), mac.begin(), mac.end());
            uint8_t cs = 0; for (auto b : msg) cs += b;
            msg.push_back(cs);
            return msg;

  - id: ${dev_id}_send_color
    then:
      - ble_client.ble_write:
          id: ${dev_id}_client
          service_uuid: ${service_uuid}
          characteristic_uuid: ${char_uuid}
          value: !lambda |-
            auto hexval = [](char c) -> uint8_t {
              if (c >= '0' && c <= '9') return (uint8_t)(c - '0');
              if (c >= 'A' && c <= 'F') return (uint8_t)(c - 'A' + 10);
              if (c >= 'a' && c <= 'f') return (uint8_t)(c - 'a' + 10);
              return 0;
            };
            auto parse_mac = [&](const std::string &s) -> std::vector<uint8_t> {
              std::vector<uint8_t> mac; mac.reserve(6);
              for (size_t i = 0; i + 1 < s.size() && mac.size() < 6;) {
                if (s[i] == ':' || s[i] == '-') { i++; continue; }
                mac.push_back((uint8_t)((hexval(s[i]) << 4) | hexval(s[i+1])));
                i += 2;
              }
              while (mac.size() < 6) mac.push_back(0x00);
              return mac;
            };

            uint8_t r  = id(${dev_id}_last_r);
            uint8_t g  = id(${dev_id}_last_g);
            uint8_t b  = id(${dev_id}_last_b);
            uint8_t cw = id(${dev_id}_last_cw);
            uint8_t ww = id(${dev_id}_last_ww);

            std::vector<uint8_t> mac = parse_mac("${dev_mac}");
            std::vector<uint8_t> msg = {0x78,0xA9,0x0E};
            msg.insert(msg.end(), mac.begin(), mac.end());
            msg.push_back(0xA8);
            msg.push_back(0x32);
            msg.push_back(r);
            msg.push_back(g);
            msg.push_back(b);
            msg.push_back(cw);
            msg.push_back(ww);
            msg.push_back(0x00);
            uint8_t cs = 0; for (auto v : msg) cs += v;
            msg.push_back(cs);

            id(${dev_id}_sent_r)  = r;
            id(${dev_id}_sent_g)  = g;
            id(${dev_id}_sent_b)  = b;
            id(${dev_id}_sent_cw) = cw;
            id(${dev_id}_sent_ww) = ww;

            return msg;

  - id: ${dev_id}_send_brightness
    then:
      - ble_client.ble_write:
          id: ${dev_id}_client
          service_uuid: ${service_uuid}
          characteristic_uuid: ${char_uuid}
          value: !lambda |-
            auto hexval = [](char c) -> uint8_t {
              if (c >= '0' && c <= '9') return (uint8_t)(c - '0');
              if (c >= 'A' && c <= 'F') return (uint8_t)(c - 'A' + 10);
              if (c >= 'a' && c <= 'f') return (uint8_t)(c - 'a' + 10);
              return 0;
            };
            auto parse_mac = [&](const std::string &s) -> std::vector<uint8_t> {
              std::vector<uint8_t> mac; mac.reserve(6);
              for (size_t i = 0; i + 1 < s.size() && mac.size() < 6;) {
                if (s[i] == ':' || s[i] == '-') { i++; continue; }
                mac.push_back((uint8_t)((hexval(s[i]) << 4) | hexval(s[i+1])));
                i += 2;
              }
              while (mac.size() < 6) mac.push_back(0x00);
              return mac;
            };

            uint8_t bri = id(${dev_id}_last_bri);

            std::vector<uint8_t> mac = parse_mac("${dev_mac}");
            std::vector<uint8_t> msg = {0x78,0x90,0x0C};
            msg.insert(msg.end(), mac.begin(), mac.end());
            msg.push_back(0x87);
            msg.push_back(bri);
            msg.push_back(0x37);
            msg.push_back(0x32);
            msg.push_back(0x00);
            msg.push_back(0x00);
            uint8_t cs = 0; for (auto v : msg) cs += v;
            msg.push_back(cs);

            id(${dev_id}_sent_bri) = bri;

            return msg;
